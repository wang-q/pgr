# ms2dna: Convert Simulated Haplotypes to DNA Sequences

`ms to-dna` is a subcommand of the `pgr` toolkit, used to convert haplotypes
generated by the popular coalescent simulation program `ms` into DNA sequences.

This tool is a Rust port of the original C version of `ms2dna`, designed to
provide efficient and robust conversion functionality.

## Usage

```bash
pgr ms to-dna [OPTIONS] [FILES]...
```

If no input files are provided, the program reads from standard input (stdin).

### Examples

```bash
# Read from file
pgr ms to-dna input.ms -o output.fasta

# Read from standard input (pipe)
ms 3 1 -t 10 -r 0 1000 | pgr ms to-dna > output.fasta
```

## Options

- `-g, --gc <FLOAT>`: Set GC content (between 0.0 and 1.0). Default is `0.5`.
  This parameter affects the generation of the ancestral sequence and the
  selection of mutated bases.
- `-s, --seed <INT>`: Set the random number seed. If not specified, the program
  uses a combination of system time and process ID as the seed.
- `--no-perturb`: Disable position micro-perturbation. By default, positions
  output by `ms` (interval [0, 1]) are slightly perturbed to simulate continuous
  positions. This option disables this behavior.
- `-v, --verbose`: Display detailed runtime information, including the seed
  used, input/output paths, etc.
- `-h, --help`: Display help information.

## Input Format

The program accepts `ms` format output. It parses the second value of the `-r`
parameter (recombination parameter) from the `ms` command line to determine the
sequence length (nsite).

For example, in the command `ms 3 1 -t 10 -r 0 1000`, the sequence length is
`1000` bp.

## Output Format

The output is in FASTA format, printed to standard output (stdout).

- **Sequence Format**: Each sequence occupies two lines: one header line
  (starting with `>`) and one sequence data line. **Sequence data is not
  wrapped**; the complete sequence is written on a single line.
- **Header Format**:
    - Single Locus, Single Population: `>S1`, `>S2`, ...
    - Multiple Loci: `>L1_S1`, `>L2_S1`, ...
    - Multiple Populations: `>P1_S1`, `>P2_S1` ... or combinations like
      `>L1_P1_S1`.

## Mutation Model

`ms` is based on the infinite sites model, assuming no position mutates twice.
However, when converting to finite-length DNA sequences, "double hits" may
occur.

The processing logic of `ms2dna` is as follows:
1.  **Map Positions**: Map the [0, 1] interval positions from `ms` to discrete
    sites in [0, nsite-1].
2.  **Collision Handling**: If two mutations map to the same site, the program
    redraws a random position until an unused site is found.
3.  **Warning**: If the number of segregating sites (`segsites`) exceeds the
    total sequence length (`nsite`), the program outputs a warning and stops
    looking for positions for the excess mutations (to prevent infinite loops).

    ```text
    #WARNING: number of segregating sites (1001) > number of mutable sites (1000)
    ```

### Ancestral Sequence and Mutations

For each sample, the program regenerates a random ancestral sequence:
- Generates ancestral bases based on the GC content specified by `-g`.
- Generates derived bases based on the mutation matrix (Transition/Transversion
  probabilities).
    - If random number `r <= gc`, the derived base tends to be G/C.
    - Otherwise, it tends to be A/T.

## Random Number Generator

The program uses a simple Linear Congruential Generator (LCG) to ensure result
reproducibility.
- Results can be reproduced by specifying the seed via the `-s` parameter.
- **Note**: Due to differences in the underlying random number algorithms, the
  sequences generated by the Rust version of `pgr ms to-dna` will differ from those
  generated by the original C version of `ms2dna`, even if the same seed is
  used.
